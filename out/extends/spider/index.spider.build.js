!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=29)}([function(e,t,r){const o=r(9);r(8);async function n(e){return new Promise((t,r)=>{try{let n={url:e.url,proxy:e.proxy,timeout:e.timeout,encoding:null,headers:{"User-Agent":i()}};o.get(n,function(e,o,n){return e?r(e):e||200!=o.statusCode?void t(n):t(n)}).on("error",function(e){console.log("get error"),r(e)})}catch(e){r(e)}})}function i(){let e=$ua.data;return 0==e.length?null:e[a(0,e.length-1)]}function a(e,t){switch(arguments.length){case 1:return parseInt(Math.random()*e+1,10);case 2:return parseInt(Math.random()*(t-e+1)+e,10);default:return 0}}e.exports={checkValidProxyIp:async function(e){console.log("验证Ip有效性:");try{try{return!!await n({url:"https://www.baidu.com",proxy:e,timeout:2e3})}catch(e){let t="err in checkValidProxyIp";return console.log(t),$logger.error(JSON.stringify({err:e,msg:t})),!1}}catch(e){throw e}},httpGet:n,randomNum:a,getUa:i}},function(e,t,r){const o=r(6),n=r(0);let i="ips in cache";e.exports=(e=>new class extends o{constructor(e){super(),this.option=e}async adds(e){try{await $cache.delete(i);let t=[];for(let r of e)await this.checkIpExist(r.ip,r.port)||t.push(r);return await this.dataModels.proxyip.bulkCreate(t),console.log("批量 ip 入库",t.length),!0}catch(e){throw e}}async add(e){try{return await $cache.delete(i),await this.checkIpExist(e.ip,e.port)?null:await this.dataModels.proxyip.create(e)}catch(e){throw e}}async checkIpExist(e,t){try{return e&&t?await this.dataModels.proxyip.findOne({where:{ip:e,port:t}}):null}catch(e){throw e}}async getIps(){try{return await this.dataModels.proxyip.findAll()}catch(e){throw e}}async loadNormalProxyIp(e){try{if(!e)throw new Error("url is empty in ProxyIp.model.loadNormalProxyIp");let t=await n.httpGet({url:e}),r=JSON.parse(t.toString());r=r.data;let o=[];for(let e of r)e&&o.push(e);await this.adds(o)}catch(e){throw e}}async loadSpiderProxyIp(e){try{if(!e)throw new Error("url is empty in ProxyIp.model.loadSpiderProxyIp");let t="",r=await async function(e){return(await n.httpGet({url:e,timeout:3e3})).toString()}(e);t=`http://${r}`;let o=r.split(":");return await this.add({type:"http",ip:o[0],port:o[1]}),t}catch(e){throw e}}async getValidIps(e){try{var t=null;let o="http://ip.16yun.cn:817/myip/pl/daa02231-a016-4556-909b-1f0f780ecfca/?s=yrmqixfxzr&u=rajan&format=json",a=await n.httpGet({url:o}),s=JSON.parse(a.toString()),c=null;var r=!1;if(s.status?(c=s.proxy,r=!0,console.log("已采集到IP数据")):(c=await $cache.get(i))||(c=await this.getIps(),console.log("未采集到IP数据，从库中读取")),c.length>0){let o=[];if(r){await $cache.set(i,c,60);for(let e of c){let t=e.type?e.type:"http";o.push({ip:e.ip,port:e.port,type:t})}await this.adds(o)}for(let r of c){let o=`${r.type?r.type:"http"}://${r.ip}:${r.port}`;if(await n.checkValidProxyIp(o)){if(!e){t=o;break}if(e!=o){t=o;break}}}return console.log("读取有效ip为，",t),t}throw new Error("ProxyIp.model.getValidIps, 没有可用ip")}catch(e){throw e}}}(e))},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("sequelize")},function(e,t,r){const o=r(3);r(28)(o);var n=null,i=[];i.push(r(13)),i.push(r(12)),e.exports=async function(){try{if(n)return n;var e=$config.db;if(!e||!e.db||!e.uname)throw new Error("数据库尚未初始化");n=new o(e.db,e.uname,e.pwd,{host:e.host,dialect:"mysql",timezone:"+08:00",freezeTableName:!1,logging:!1,pool:{max:5,min:0,idle:3e4}});for(let e of i)n.define(e.name,e.body,{timestamps:!1,underscored:!0,freezeTableName:!0,tableName:e.tableName});return await n.sync({force:!1}),console.log("init db",(new Date).getTime()),t=n,async function(e){}(),t}catch(e){throw"初始化数据库失败"+e}var t}},function(e,t,r){const o=r(18)(),n=r(22),i=r(1)(),a=r(9),s=r(8),c=r(2),l=r(0);var p=0,u=(new Map,1);async function d(e){try{if(e&&e.length>0){return await o.setArticles(e)&&(console.log(`第${p+1}次采集，插入${e.length}条，`),e=[]),!0}return!1}catch(e){throw console.log("存储采集数据失败"),e}}async function g(e){let t=e.url;e.headers||(e.headers={});var r={url:t,encoding:null,headers:{"content-type":"*/*","Accept-Encoding":"gzip, deflate","Accept-Language":"zh-CN,zh;q=0.8",Connection:"keep-alive","Content-Length":"151","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Cookie:"yunsuo_session_verify=85b586114d427177d4b13e7688644fa9; JSESSIONID=pLZybHqVlz5Q9g9sTWTlQwQk6pWBcP77W34blV8cdd0GSQS23Bxl!519234059; xincaigou=49737.2929.22.0000",Host:"www.yngp.com",Origin:"http://www.yngp.com",Referer:"http://www.yngp.com/bulletin.do?method=moreList&menuSelect=nav2","User-Agent":l.getUa(),"X-Requested-With":"XMLHttpRequest"},form:{current:e.page?e.page:1,rowCount:e.psize?e.psize:100,searchPhrase:"",query_bulletintitle:"",query_startTime:"2000-01-01",query_endTime:"2018-10-18",query_sign:1,query_codeName:"",query_gglxdm:"bxlx005"}};return e.proxy&&(r.proxy=e.proxy),new Promise((e,t)=>{try{a.post(r,function(r,o,n){try{if(r||200!=o.statusCode)t(r);else{let t=s.decode(n,"gb2312");e(JSON.parse(t))}}catch(e){t(e)}}).on("error",function(e){t(e)})}catch(e){t(e)}})}e.exports=(e=>new class{constructor(e){this.option=e}async cgSpideer(){try{await $common.sleep(3e3),console.log("start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");var e=async function(){let e=await o.getAllTitle();for(let t of e)await $cache.set("title_cache"+t.title,1);console.log("初始化title 缓存")};await e();for(var t=null;!t;)console.log("读取可用ip..."),t=await i.getValidIps();console.log("可用ip...",t);var r="http://www.yngp.com/bulletin.do?method=moreListQuery";let y=await g({url:r,page:1,psize:100,proxy:t,headers:{ua:l.getUa()}});var a=[];let f=Number(y.totlePageCount),w=y.total,m=await $cache.get("spider-page"),x=m?Number(m):Number(u),S=0;for(;x<=f;){console.log("采集页数++++++++++++++++++++++++++++++",x);for(var s=null;!s;)(s=await i.getValidIps(t))&&(t=s);if((y=await g({proxy:t,url:r,page:x,psize:100,headers:{ua:l.getUa()}})).rows.length>0){var h=await $cache.get(`page_${x}_index`)?Number(await $cache.get(`page_${x}_index`)):0;for(console.log(`第${x}页从下标为${h}开始读取`);h<y.rows.length;h++){let r=y.rows[h];if(await $cache.set(`page_${x}_index`,h),r){if(await $cache.get("title_cache"+r.bulletintitle)){console.log(`第${p+1}次采集，检测到重复数据，无需入库，`,r.bulletintitle.slice(0,60));continue}for(s=null;!s;)(s=await i.getValidIps(t))&&(t=s);let o=`http://www.yngp.com/newbulletin_zz.do?method=preinsertgomodify&operator_state=1&flag=view&bulletin_id=${r.bulletin_id}`,u=await l.httpGet({url:o,proxy:t,headers:{ua:l.getUa()}});console.log("读取内容休眠"),await $common.sleep(1200);let g=n.load(u)("#searchPanel").html(),h="./articleContent/"+r.bulletin_id+".txt";c.writeFileSync(h,g);let y={title:r.bulletintitle,area:r.codeName,atime:r.finishday,intro:"",class:r.bulletinclass,catchTime:new Date,resource:"中国政府采购网云南分网",content:h,url:o};a.push(y),console.log("该条数据可以入库"),a.length>10&&await d(a)&&(await e(),a=[])}}await $cache.delete(`page_${x}_index`)}u=++x,await $cache.set("spider-page",x),await $common.sleep(5e3)}let b=(new Date).getTime(),$=`第${++p}次采集，采集完成时间：${$common.dateFormate(new Date,"yyyy-MM-dd hh:mm:ss")}，\n            耗时：${((b-starttime)/6e4).toFixed(0)}分钟，共采集${w}条，入库${S}条，`;console.log($),$logger.createLogger(__dirname+"cgCache.log").info($)}catch(e){console.log("采购网读取数据发生异常",e),$logger.error({err:e,currentPage:u}),await d(a)&&(a=[],console.log("程序异常数据存储补救措施.....")),this.cgSpideer()}}async getSpiderProxy(){try{let e="http://api.ip.data5u.com/dynamic/get.html?order=318a742f5f30a0bea3134d9d5bc28f40&sep=3",t=await l.get({url:e,timeout:3e3}),r=[];for(;r.length<=10;)if(t)if(await l.checkValidProxyIp(`http://${t}`)){let e=t.split(":");r.push({type:"http",ip:e[0],port:e[1]}),console.log("ip 可用",t)}else console.log("ip 不可用",t);await i.adds(r)}catch(e){throw e}}}(e))},function(e,t,r){e.exports=class{constructor(){this.dbInit()}async dbInit(){const e=await r(4)();this.db=e,this.dataModels=e.models}}},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("iconv-lite")},function(e,t){e.exports=require("request")},function(e,t,r){const o=r(24),n=r(2),i=r(23);global.$taskConfig=JSON.parse(o(n.readFileSync("extends.config.json").toString())),1==$taskConfig.debug?global.$config=JSON.parse(o(n.readFileSync("../../config.json").toString())):global.$config=JSON.parse(o(n.readFileSync("./config.json").toString())),global.$ua=JSON.parse(o(n.readFileSync("./ua.json").toString())),global.$common=r(11),global.$cache=r(15)();const a=r(5)();global.$logger=r(16);r(0),r(1)();if(i.isMaster){!async function(){try{for(;;){let e=Number($config.spider.sleep);await a.cgSpideer(),console.log("***************蜘蛛休息中 φ(>ω<*)..... ******************"),await $common.sleep(6e4*e)}}catch(e){console.log("程序异常",e)}}()}i.isWorker&&r(14)(i,process)},function(e,t,r){const o=r(21);r(2);e.exports={_error(e){throw`common.lib error: ${e}`},writeLog(e){e&&logModel.create({content:JSON.stringify(e),type:1})},getPageForSql(e,t){return e&&t||this._error("getPageForSql，page 或者psize 不能为空"),e=parseInt(e),--e<0&&(e=1),{limit:parseInt(t),offset:parseInt(e)*parseInt(t)}},getRandomString:()=>o(),formateDate:(e,t)=>o(),isArray:e=>"[object Array]"==Object.prototype.toString.call(e),isAdminLogin:async e=>!!await $req.session("admin")||(e&&e.deny("管理员尚未登录"),!1),dateFormate:(e,t)=>(Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var r in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e},e?new Date(e).Format(t):(new Date).Format(t)),sleep:e=>new Promise(t=>{setTimeout(()=>{t()},e)}),arrMerge(e){let t=[];for(let r of e)for(let e of r)t.push(e);return t},md5(e){const t=r(7).createHash("md5");return t.update(e),t.digest("hex")}}},function(e,t,r){const o=r(3);e.exports={name:"proxyip",tableName:"proxyip",body:{id:{type:o.INTEGER,primaryKey:!0,autoIncrement:!0},ip:o.STRING(128),port:o.STRING(512),type:o.STRING(128),city:o.STRING(128),province:o.STRING(128),country:o.STRING(128),isp:o.STRING(128),anonymity:o.STRING(128),connectTimeMs:o.INTEGER}}},function(e,t,r){const o=r(3);e.exports={name:"spiderArticle",tableName:"spider_article",body:{id:{type:o.INTEGER,primaryKey:!0,autoIncrement:!0},title:o.STRING(512),resource:o.STRING(512),intro:o.TEXT,url:o.TEXT,content:o.TEXT("long"),area:o.STRING(128),class:o.STRING(128),atime:o.DATE,catchTime:o.DATE}}},function(e,t,r){var o=null,n=null;r(5)();const i=r(1)();e.exports=(async e=>{for(o=e.worker.process,n=(e=e).worker,setInterval(()=>{console.log("worker runing ....",n.id)},6e3),o.on("message",function(e){!function(e){e&&"die"==e.type&&(console.log("worker is going to close"),n.disconnect(),setTimeout(function(){console.log("worker is disconnect"),o.exit(1)},4e3))}(e)}),await $common.sleep(2e3);;)await i.loadSpiderProxyIp($config.spider.getProxyUrl),await $common.sleep(3e3)})},function(e,t,r){const o=r(17)();e.exports=(()=>{if(1!=$config.redis.use)throw"无法启用缓存，请先开启redis功能";if(!o)throw"redis 实例获取失败";return{async get(e){try{let t=await o.getSync(e);return JSON.parse(t)}catch(e){throw e}},async set(e,t,r){try{return e&&t?(t=JSON.stringify(t),r?await o.setexSync(e,r,t):await o.setSync(e,t)):null}catch(e){throw e}},async expire(e,t){try{return e&&t?await o.expire(e,t):null}catch(e){throw e}},async delete(e){try{return e?await o.deleteSync(e):null}catch(e){throw e}}}})},function(e,t,r){const o=r(25);r(26);o.configure({appenders:{everything:{type:"dateFile",filename:process.cwd()+"/logs/all-the-logs.log",maxLogSize:1048576,backups:3,compress:!0}},categories:{default:{appenders:["everything"],level:"debug"}}});const n=o.getLogger("log4jslog");e.exports={error:e=>{n.error(e)},trace:e=>{n.trace(e)},info:e=>{n.info(e)},trace:e=>{n.trace(e)},debug:e=>{n.debug(e)},warn:e=>{n.warn(e)},fatal:e=>{n.fatal(e)}}},function(e,t,r){const o=r(27);var n=null;e.exports=(()=>{var e=$config.redis;if(!e||1!=e.use)return null;if(!e||!e.host||!e.port)throw"redis 配置信息为空，无法配置";if(n)return n;let t=o.createClient(e.port,e.host,{auth_pass:e.pass});return t.on("ready",e=>{console.log("redis cache init ok ")}),t.keysSync=(e=>(e||(e="*"),new Promise((r,o)=>{t.keys(e,(e,t)=>{e&&o(e),r(t)})}))),t.expireSync=((e,r)=>new Promise((o,n)=>{e||n("redis.js expireSync errir:key can not be empty "),t.expire(e,r,(e,t)=>{e&&n(e),o(t)})})),t.getSync=(e=>new Promise((r,o)=>{t.get(e,(e,t)=>{e?o({position:"cache.get",err:e}):r(JSON.parse(t))})})),t.setexSync=((e,r,o)=>new Promise((n,i)=>{o=JSON.stringify(o),t.setex(e,r,o,(e,t)=>{e?i({position:"redis.setexSync",err:e}):n(t)})})),t.setSync=((e,r)=>new Promise((o,n)=>{r=JSON.stringify(r),t.set(e,r,(e,t)=>{e?n({position:"redis.setSync",err:e}):o(t)})})),t.deleteSync=(e=>new Promise((r,o)=>{e?t.del(e,(e,t)=>{e?o({position:"redis.deleteSync",err:e}):r(JSON.stringify(t))}):o({position:"redis.deleteSync",err:"key can not be empty"})})),n=t})},function(e,t,r){const o=r(6);r(4)();e.exports=(e=>new class extends o{constructor(){super()}async getAllTitle(){try{return await this.dataModels.spiderArticle.findAll({attr:["title"]})}catch(e){throw e}}async setArticle(e){try{return await this.dataModels.spiderArticle.create(e)}catch(e){throw e}}async setArticles(e){try{return await this.dataModels.spiderArticle.bulkCreate(e)}catch(e){throw e}}async getArticleByTitle(e){try{return await this.dataModels.spiderArticle.findOne({where:{title:e}})}catch(e){throw e}}}(e))},function(e,t){for(var r=[],o=0;o<256;++o)r[o]=(o+256).toString(16).substr(1);e.exports=function(e,t){var o=t||0,n=r;return n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]}},function(e,t,r){var o=r(7);e.exports=function(){return o.randomBytes(16)}},function(e,t,r){var o,n,i=r(20),a=r(19),s=0,c=0;e.exports=function(e,t,r){var l=t&&r||0,p=t||[],u=(e=e||{}).node||o,d=void 0!==e.clockseq?e.clockseq:n;if(null==u||null==d){var g=i();null==u&&(u=o=[1|g[0],g[1],g[2],g[3],g[4],g[5]]),null==d&&(d=n=16383&(g[6]<<8|g[7]))}var h=void 0!==e.msecs?e.msecs:(new Date).getTime(),y=void 0!==e.nsecs?e.nsecs:c+1,f=h-s+(y-c)/1e4;if(f<0&&void 0===e.clockseq&&(d=d+1&16383),(f<0||h>s)&&void 0===e.nsecs&&(y=0),y>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=h,c=y,n=d;var w=(1e4*(268435455&(h+=122192928e5))+y)%4294967296;p[l++]=w>>>24&255,p[l++]=w>>>16&255,p[l++]=w>>>8&255,p[l++]=255&w;var m=h/4294967296*1e4&268435455;p[l++]=m>>>8&255,p[l++]=255&m,p[l++]=m>>>24&15|16,p[l++]=m>>>16&255,p[l++]=d>>>8|128,p[l++]=255&d;for(var x=0;x<6;++x)p[l+x]=u[x];return t||a(p)}},function(e,t){e.exports=require("cheerio")},function(e,t){e.exports=require("cluster")},function(e,t){e.exports=require("jsonminify")},function(e,t){e.exports=require("log4js")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("sequelize-values")},function(e,t,r){e.exports=r(10)}]);